#!/bin/bash

if test -e /tmp/langstonefft ; then
rm /tmp/langstonefft
fi
mkfifo /tmp/langstonefft

if test -e /tmp/langstoneTx ;then
rm /tmp/langstoneTx
fi
mkfifo /tmp/langstoneTx

if test -e /tmp/langstoneRx ;then
rm /tmp/langstoneRx
fi
mkfifo /tmp/langstoneRx


if !(ps -ax |grep -v grep| grep -q Lang_TX.py) then
	sudo amixer -c1 cset numid=6 100%  > /dev/null 2>&1
	sudo amixer -c1 cset numid=8 50%  > /dev/null 2>&1
	sudo cp /home/pi/Langstone/splashload.bgra /dev/fb0
        sudo raspi-gpio set 17,18 pu
   
 retry=0
 until [ ${retry} -ge 4 ]
do
	(iio_info -n pluto.local 2>/dev/null | grep -q PlutoSDR) && break
	retry=$[${retry}+1]
	sleep 1
done

if [ ${retry} -ge 4 ]; then
  clear
  sudo cp /home/pi/Langstone/plutofail.bgra /dev/fb0
  exit 1
fi
  
  python /home/pi/Langstone/Lang_TX.py > /tmp/LangstoneTX.log 2>&1 &
  python /home/pi/Langstone/Lang_RX.py > /tmp/LangstoneRX.log 2>&1 &
sleep 2
	if (ps -ax | grep -v grep| grep -q Lang_TX.py)then
	  /home/pi/Langstone/GUI > /tmp/LangstoneGUI.log 2>&1
	else
		sudo cp /home/pi/Langstone/gnufail.bgra /dev/fb0
	fi
else
	echo Langstone is already running. Use ./stop first.
fi




